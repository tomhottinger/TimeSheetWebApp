<!DOCTYPE html>

<html lang="de">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Zeiterfassung - {{ current_user.username }}</title>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }

        

        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;

            background: #fafafa;

            color: #333;

            line-height: 1.5;

            font-size: 14px;

        }

        

        .container {

            max-width: 1000px;

            margin: 0 auto;

            padding: 20px;

        }

        

        .header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 30px;

        }

        

        .nav-links {

            display: flex;

            gap: 15px;

            align-items: center;

        }

        

        .nav-link {

            color: #0969da;

            text-decoration: none;

            font-size: 14px;

            padding: 8px 12px;

            border: 1px solid #0969da;

            background: white;

            border-radius: 4px;

        }

        

        .nav-link:hover {

            background: #f6f8fa;

        }

        

        h1 {

            font-size: 24px;

            font-weight: 400;

            color: #222;

        }

        

        .user-info {

            display: flex;

            align-items: center;

            gap: 10px;

            background: white;

            padding: 8px 12px;

            border: 1px solid #e1e5e9;

        }

        

        .user-switch {

            color: #0969da;

            text-decoration: none;

            font-size: 12px;

        }

        

        .user-switch:hover {

            text-decoration: underline;

        }

        

        h2 {

            font-size: 16px;

            font-weight: 500;

            margin-bottom: 15px;

            color: #444;

        }

        

        input[type="text"] {

            flex: 1;

            min-width: 200px;

            padding: 8px 12px;

            border: 1px solid #d0d7de;

            background: white;

            font-size: 14px;

            outline: none;

        }

        

        input[type="text"]:focus {

            border-color: #0969da;

        }

        

        .color-selector {

            display: flex;

            gap: 8px;

            align-items: center;

        }

        

        .preset-color {

            width: 20px;

            height: 20px;

            border: 1px solid #d0d7de;

            cursor: pointer;

        }

        

        .preset-color:hover {

            border-color: #666;

        }

        

        .preset-color.selected {

            border-color: #000;

            border-width: 2px;

        }

        

        .custom-color {

            width: 24px;

            height: 20px;

            border: 1px solid #d0d7de;

            cursor: pointer;

            background: white;

        }

        

        .btn {

            padding: 8px 16px;

            border: 1px solid #d0d7de;

            background: white;

            color: #333;

            cursor: pointer;

            font-size: 14px;

            text-decoration: none;

            display: inline-block;

        }

        

        .btn:hover {

            background: #f6f8fa;

        }

        

        .btn-primary {

            background: #0969da;

            color: white;

            border-color: #0969da;

        }

        

        .btn-primary:hover {

            background: #0860ca;

        }

        

        .current-timer {

            text-align: center;

            margin-bottom: 20px;

            font-size: 16px;

            color: #666;

        }

        

        .stop-btn {

            background: #1a7f37;

            color: white;

            border-color: #1a7f37;

        }

        

        .tickets-grid {

            display: grid;

            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));

            gap: 1px;

            background: #d0d7de;

            border: 1px solid #d0d7de;

            margin-bottom: 30px;

        }

        

        .ticket-btn {

            padding: 12px 16px;

            background: white;

            color: white;

            text-decoration: none;

            text-align: center;

            font-size: 13px;

            font-weight: 500;

            display: flex;

            align-items: center;

            justify-content: center;

            min-height: 48px;

            border: none;

            cursor: pointer;

            position: relative;

        }

        

        .ticket-btn:hover {

            opacity: 0.9;

        }

        

        .ticket-btn.active {

            box-shadow: inset 0 0 0 2px #000;

        }

        

        .add-btn {

            background: #656d76;

            color: white;

            font-size: 24px;

            font-weight: bold;

        }

        

        .add-btn:hover {

            opacity: 0.8;

        }

        

        .ticket-actions {

            position: absolute;

            top: 4px;

            right: 4px;

            display: none;

            gap: 2px;

        }

        

        .ticket-btn:hover .ticket-actions {

            display: flex;

        }

        

        .action-btn {

            width: 18px;

            height: 18px;

            border: none;

            cursor: pointer;

            border-radius: 50%;

            font-size: 10px;

            line-height: 1;

            font-weight: bold;

        }

        

        .edit-ticket-btn {

            background: rgba(9, 105, 218, 0.9);

            color: white;

        }

        

        .delete-ticket-btn {

            background: rgba(0,0,0,0.8);

            color: white;

        }

        

        .modal {

            display: none;

            position: fixed;

            z-index: 1000;

            left: 0;

            top: 0;

            width: 100%;

            height: 100%;

            background-color: rgba(0,0,0,0.5);

        }

        

        .modal-content {

            background-color: white;

            margin: 10% auto;

            padding: 20px;

            border: 1px solid #e1e5e9;

            width: 400px;

            max-width: 90%;

        }

        

        .modal h3 {

            margin-bottom: 20px;

            font-size: 18px;

            font-weight: 500;

            color: #333;

        }

        

        .modal-form {

            display: flex;

            flex-direction: column;

            gap: 15px;

        }

        

        .modal-form input[type="text"] {

            padding: 10px;

            border: 1px solid #d0d7de;

            font-size: 14px;

            outline: none;

        }

        

        .modal-form input[type="text"]:focus {

            border-color: #0969da;

        }

        

        .modal-form label {

            font-weight: 500;

            color: #333;

            margin-bottom: 5px;

        }

        

        .modal-buttons {

            display: flex;

            gap: 10px;

            justify-content: flex-end;

            margin-top: 20px;

        }

        

        .btn-cancel {

            background: #f6f8fa;

            border-color: #d0d7de;

            color: #333;

        }

        

        .entries-section {

            background: white;

            border: 1px solid #e1e5e9;

        }

        

        .date-section {

            border-bottom: 1px solid #e1e5e9;

        }

        

        .date-section:last-child {

            border-bottom: none;

        }

        

        .date-header {

            background: #f6f8fa;

            padding: 12px 16px;

            border-bottom: 1px solid #e1e5e9;

            cursor: pointer;

            display: flex;

            justify-content: space-between;

            align-items: center;

            font-weight: 500;

            color: #333;

        }

        

        .date-header:hover {

            background: #f1f3f4;

        }

        

        .date-header.today {

            background: #dbeafe;

            border-bottom-color: #93c5fd;

        }

        

        .collapse-icon {

            color: #666;

            font-size: 12px;

        }

        

        .collapsed .collapse-icon {

            transform: rotate(-90deg);

        }

        

        .date-entries {

            border-bottom: 1px solid #e1e5e9;

        }

        

        .date-entries:last-child {

            border-bottom: none;

        }

        

        .entries-table {

            width: 100%;

            border-collapse: collapse;

            font-size: 13px;

        }

        

        .entries-table th {

            background: white;

            padding: 8px 12px;

            text-align: left;

            font-weight: 500;

            color: #333;

            border-bottom: 1px solid #e1e5e9;

        }

        

        .entries-table td {

            padding: 8px 12px;

            border-bottom: 1px solid #f1f3f4;

            vertical-align: middle;

        }

        

        .entries-table tr:hover {

            background: #f6f8fa;

        }

        

        .entries-table input, .entries-table textarea {

            width: 100%;

            padding: 4px 6px;

            border: 1px solid #d0d7de;

            background: white;

            font-size: 12px;

            outline: none;

        }

        

        .entries-table input:focus, .entries-table textarea:focus {

            border-color: #0969da;

        }

        

        .entries-table textarea {

            resize: vertical;

            min-height: 32px;

            font-family: inherit;

        }

        

        .duration {

            font-weight: 500;

            text-align: right;

            color: #333;

        }

        

        .delete-btn {

            background: #cf222e;

            color: white;

            border: none;

            padding: 4px 8px;

            cursor: pointer;

            font-size: 12px;

        }

        

        .delete-btn:hover {

            background: #a40e26;

        }

        

        .running-indicator {

            color: #1a7f37;

            font-weight: 500;

        }

        

        .no-tickets {

            text-align: center;

            color: #656d76;

            padding: 40px 20px;

            background: white;

        }

        

        .day-total {

            color: #656d76;

            font-size: 12px;

        }

        

        @media (max-width: 768px) {

            .container {

                padding: 15px;

            }

            

            .header {

                flex-direction: column;

                align-items: flex-start;

                gap: 10px;

            }

            

            .tickets-grid {

                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));

            }

            

            .entries-table th, .entries-table td {

                padding: 6px 8px;

            }

        }

    </style>

</head>

<body>

    <div class="container">

        <div class="header">

            <h1>Zeiterfassung</h1>

            <div class="nav-links">

                <a href="{{ url_for('summary') }}" class="nav-link">Zusammenfassung</a>

            </div>

            <div class="user-info">

                <span>👤 {{ current_user.username }}</span>

                <a href="{{ url_for('select_user') }}" class="user-switch">Wechseln</a>

            </div>

        </div>

        

        <!-- Tickets Section at the top -->

        <div class="tickets-grid">

            <!-- Stop/Pause Button as first ticket -->

            {% if current_entry_id %}

            <a href="{{ url_for('stop_timer') }}" class="ticket-btn" style="background-color: #1a7f37;">

                Stopp

            </a>

            {% else %}

            <div class="ticket-btn" style="background-color: #656d76; cursor: not-allowed; opacity: 0.6;">

                Stopp

            </div>

            {% endif %}

            

            <!-- Regular Tickets -->

            {% for ticket in tickets %}

            <div class="ticket-btn {% if current_entry_id %}{% for entry in entries %}{% if entry.id == current_entry_id and entry.ticket_name == ticket.name %}active{% endif %}{% endfor %}{% endif %}"

                 style="background-color: {{ ticket.color }};">

                <a href="{{ url_for('start_timer', ticket_name=ticket.name) }}" 

                   style="color: inherit; text-decoration: none; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">

                    {{ ticket.name }}

                </a>

                <div class="ticket-actions">

                    <button class="action-btn edit-ticket-btn" onclick="event.stopPropagation(); openEditTicketModal('{{ ticket.id }}')" title="Bearbeiten">✏</button>

                    <button class="action-btn delete-ticket-btn" onclick="event.stopPropagation(); if(confirm('Ticket {{ ticket.name }} löschen?')) window.location.href='{{ url_for('delete_ticket', ticket_id=ticket.id) }}'" title="Löschen">×</button>

                </div>

            </div>

            {% endfor %}

            

            <!-- Add Button -->

            <div class="ticket-btn add-btn" onclick="openAddTicketModal()">

                +

            </div>

        </div>

        

        <!-- Add/Edit Ticket Modal -->

        <div id="ticketModal" class="modal" onclick="closeModalOnOutsideClick(event)">

            <div class="modal-content" onclick="event.stopPropagation()">

                <h3 id="modalTitle">Neues Zeitkonto erstellen</h3>

                <form class="modal-form" id="ticketForm" action="{{ url_for('add_ticket') }}" method="post">

                    <input type="hidden" id="ticketId" name="ticket_id" value="">

                    <div>

                        <label for="modal-name">Name*</label>

                        <input type="text" id="modal-name" name="name" placeholder="Ticket/Auftrag Name" required>

                    </div>

                    <div>

                        <label for="modal-jira">Jira-Ticketnummer</label>

                        <input type="text" id="modal-jira" name="jira_ticket" placeholder="z.B. PROJ-123">

                    </div>

                    <div>

                        <label for="modal-matrix">Matrix-Ticketnummer</label>

                        <input type="text" id="modal-matrix" name="matrix_ticket" placeholder="z.B. MTX-456">

                    </div>

                    <div>

                        <label>Farbe</label>

                        <div class="color-selector">

                            <div class="preset-color" style="background-color: #cf222e;" onclick="selectModalColor('#cf222e')" title="Rot"></div>

                            <div class="preset-color" style="background-color: #fb8500;" onclick="selectModalColor('#fb8500')" title="Orange"></div>

                            <div class="preset-color" style="background-color: #ffd60a;" onclick="selectModalColor('#ffd60a')" title="Gelb"></div>

                            <div class="preset-color" style="background-color: #1a7f37;" onclick="selectModalColor('#1a7f37')" title="Grün"></div>

                            <div class="preset-color" style="background-color: #0969da;" onclick="selectModalColor('#0969da')" title="Blau"></div>

                            <div class="preset-color" style="background-color: #8250df;" onclick="selectModalColor('#8250df')" title="Violett"></div>

                            <div class="preset-color selected" style="background-color: #656d76;" onclick="selectModalColor('#656d76')" title="Grau"></div>

                            <input type="color" name="color" class="custom-color" value="#656d76" title="Eigene Farbe wählen">

                        </div>

                    </div>

                    <div class="modal-buttons">

                        <button type="button" class="btn btn-cancel" onclick="closeTicketModal()">Abbrechen</button>

                        <button type="submit" class="btn btn-primary" id="submitBtn">Erstellen</button>

                    </div>

                </form>

            </div>

        </div>

        

        <!-- Current Timer Display -->

        <div class="current-timer" id="currentTimer">

            {% if current_entry_id %}

                Timer läuft...

            {% else %}

                Bereit für neue Zeiterfassung

            {% endif %}

        </div>

        

        <!-- Entries Table -->

        <div class="entries-section">

            <h2>Erfasste Zeiten</h2>

            {% if entries %}

                {% for date in entries_by_date.keys()|sort(reverse=True) %}

                    {% set day_entries = entries_by_date[date] %}

                    <div class="date-section">

                        <div class="date-header {% if date == today %}today{% endif %} {% if date != today %}collapsed{% endif %}" onclick="toggleDateSection('{{ date }}')">

                            <span>

                                {% if date == today %}

                                    Heute ({{ date }})

                                {% else %}

                                    {{ date }}

                                {% endif %}

                                {% set day_total = 0 %}

                                {% for entry in day_entries %}

                                    {% if entry.end_time %}

                                        {% set start = entry.start_time | as_datetime %}

                                        {% set end = entry.end_time | as_datetime %}

                                        {% set duration = ((end - start).total_seconds() / 3600) | round(2) %}

                                        {% set day_total = day_total + duration %}

                                    {% endif %}

                                {% endfor %}

                                {% if day_total > 0 %}

                                    <span class="day-total">- {{ "%.2f"|format(day_total) }}h</span>

                                {% endif %}

                            </span>

                            <span class="collapse-icon">▼</span>

                        </div>

                        <div class="date-entries" id="entries-{{ date }}" {% if date != today %}style="display: none;"{% endif %}>

                            <table class="entries-table">

                                <thead>

                                    <tr>

                                        <th>Ticket</th>

                                        <th>Start</th>

                                        <th>Ende</th>

                                        <th>Dauer</th>

                                        <th>Bemerkungen</th>

                                        <th>Aktionen</th>

                                    </tr>

                                </thead>

                                <tbody>

                                    {% for entry in day_entries|sort(attribute='start_time', reverse=True) %}

                                    <tr>

                                        <td><strong>{{ entry.ticket_name }}</strong></td>

                                        <td style="width: 140px;">

                                            <form style="display: inline;" action="{{ url_for('update_entry') }}" method="post">

                                                <input type="hidden" name="entry_id" value="{{ entry.id }}">

                                                <input type="datetime-local" name="start_time" 

                                                       value="{{ entry.start_time[:19] if entry.start_time else '' }}"

                                                       onchange="this.form.submit()" style="width: 130px;">

                                                <input type="hidden" name="end_time" value="{{ entry.end_time[:19] if entry.end_time else '' }}">

                                                <input type="hidden" name="memo" value="{{ entry.memo }}">

                                            </form>

                                        </td>

                                        <td style="width: 140px;">

                                            {% if entry.end_time %}

                                            <form style="display: inline;" action="{{ url_for('update_entry') }}" method="post">

                                                <input type="hidden" name="entry_id" value="{{ entry.id }}">

                                                <input type="hidden" name="start_time" value="{{ entry.start_time[:19] if entry.start_time else '' }}">

                                                <input type="datetime-local" name="end_time" 

                                                       value="{{ entry.end_time[:19] }}"

                                                       onchange="this.form.submit()" style="width: 130px;">

                                                <input type="hidden" name="memo" value="{{ entry.memo }}">

                                            </form>

                                            {% else %}

                                            <span class="running-indicator">Läuft...</span>

                                            {% endif %}

                                        </td>

                                        <td class="duration" style="width: 60px;">

                                            {% if entry.end_time %}

                                                {% set start = entry.start_time | as_datetime %}

                                                {% set end = entry.end_time | as_datetime %}

                                                {% set duration = ((end - start).total_seconds() / 3600) | round(2) %}

                                                {{ "%.2f"|format(duration) }}h

                                            {% else %}

                                                <span id="running-{{ entry.id }}">Läuft...</span>

                                            {% endif %}

                                        </td>

                                        <td>

                                            <form style="display: inline;" action="{{ url_for('update_entry') }}" method="post">

                                                <input type="hidden" name="entry_id" value="{{ entry.id }}">

                                                <input type="hidden" name="start_time" value="{{ entry.start_time[:19] if entry.start_time else '' }}">

                                                <input type="hidden" name="end_time" value="{{ entry.end_time[:19] if entry.end_time else '' }}">

                                                <textarea name="memo" placeholder="Bemerkungen..." onchange="this.form.submit()">{{ entry.memo }}</textarea>

                                            </form>

                                        </td>

                                        <td style="width: 60px;">

                                            <button class="delete-btn" onclick="if(confirm('Eintrag löschen?')) window.location.href='{{ url_for('delete_entry', entry_id=entry.id) }}'">×</button>

                                        </td>

                                    </tr>

                                    {% endfor %}

                                </tbody>

                            </table>

                        </div>

                    </div>

                {% endfor %}

            {% else %}

            <div class="no-tickets">

                Noch keine Zeiten erfasst.

            </div>

            {% endif %}

        </div>

    </div>

    

    <script>

        // Modal functionality

        function openAddTicketModal() {

            const modal = document.getElementById('ticketModal');

            const form = document.getElementById('ticketForm');

            const title = document.getElementById('modalTitle');

            const submitBtn = document.getElementById('submitBtn');

            const ticketIdField = document.getElementById('ticketId');

            

            // Reset for add mode

            form.action = '{{ url_for("add_ticket") }}';

            title.textContent = 'Neues Zeitkonto erstellen';

            submitBtn.textContent = 'Erstellen';

            ticketIdField.value = '';

            

            // Reset form

            form.reset();

            

            // Reset color selection

            document.querySelectorAll('.preset-color').forEach(el => {

                el.classList.remove('selected');

            });

            document.querySelector('.preset-color[style*="#656d76"]').classList.add('selected');

            document.querySelector('input[name="color"]').value = '#656d76';

            

            modal.style.display = 'block';

            document.getElementById('modal-name').focus();

        }

        

        function openEditTicketModal(ticketId) {

            const modal = document.getElementById('ticketModal');

            const form = document.getElementById('ticketForm');

            const title = document.getElementById('modalTitle');

            const submitBtn = document.getElementById('submitBtn');

            const ticketIdField = document.getElementById('ticketId');

            

            // Set to edit mode

            form.action = '{{ url_for("update_ticket") }}';

            title.textContent = 'Zeitkonto bearbeiten';

            submitBtn.textContent = 'Speichern';

            ticketIdField.value = ticketId;

            

            // Fetch ticket data

            fetch(`/get_ticket/${ticketId}`)

                .then(response => response.json())

                .then(data => {

                    if (data.error) {

                        alert('Fehler: ' + data.error);

                        return;

                    }

                    

                    // Fill form with ticket data

                    document.getElementById('modal-name').value = data.name;

                    document.getElementById('modal-jira').value = data.jira_ticket || '';

                    document.getElementById('modal-matrix').value = data.matrix_ticket || '';

                    

                    // Set color

                    document.querySelectorAll('.preset-color').forEach(el => {

                        el.classList.remove('selected');

                    });

                    

                    const colorInput = document.querySelector('input[name="color"]');

                    colorInput.value = data.color;

                    

                    // Find matching preset color or mark as custom

                    const matchingPreset = document.querySelector(`.preset-color[style*="${data.color}"]`);

                    if (matchingPreset) {

                        matchingPreset.classList.add('selected');

                    }

                    

                    modal.style.display = 'block';

                    document.getElementById('modal-name').focus();

                })

                .catch(error => {

                    console.error('Error:', error);

                    alert('Fehler beim Laden der Ticket-Daten');

                });

        }

        

        function closeTicketModal() {

            document.getElementById('ticketModal').style.display = 'none';

        }

        

        function closeModalOnOutsideClick(event) {

            if (event.target.id === 'ticketModal') {

                closeTicketModal();

            }

        }

        

        function selectModalColor(color) {

            // Remove selected class from all preset colors

            document.querySelectorAll('.preset-color').forEach(el => {

                el.classList.remove('selected');

            });

            

            // Add selected class to clicked color

            event.target.classList.add('selected');

            

            // Set the color input value

            document.querySelector('input[name="color"]').value = color;

        }

        

        // Close modal with Escape key

        document.addEventListener('keydown', function(event) {

            if (event.key === 'Escape') {

                closeTicketModal();

            }

        });

        

        // Toggle date sections

        function toggleDateSection(date) {

            const entries = document.getElementById('entries-' + date);

            const header = event.currentTarget;

            

            if (entries.style.display === 'none') {

                entries.style.display = 'block';

                header.classList.remove('collapsed');

            } else {

                entries.style.display = 'none';

                header.classList.add('collapsed');

            }

        }

        

        // Update running timer every second

        function updateRunningTimer() {

            fetch('/current_duration')

                .then(response => response.json())

                .then(data => {

                    if (data.duration > 0) {

                        const hours = Math.floor(data.duration / 3600);

                        const minutes = Math.floor((data.duration % 3600) / 60);

                        const seconds = Math.floor(data.duration % 60);

                        

                        const timeString = 

                            String(hours).padStart(2, '0') + ':' +

                            String(minutes).padStart(2, '0') + ':' +

                            String(seconds).padStart(2, '0');

                        

                        document.getElementById('currentTimer').innerHTML = 

                            '🟢 Timer läuft: ' + timeString;

                        

                        // Update running entries in table

                        const runningElements = document.querySelectorAll('[id^="running-"]');

                        runningElements.forEach(el => {

                            el.innerHTML = timeString;

                        });

                    }

                })

                .catch(error => console.error('Error:', error));

        }

        

        // Update every second if timer is running

        {% if current_entry_id %}

        setInterval(updateRunningTimer, 1000);

        updateRunningTimer(); // Initial call

        {% endif %}

    </script>

</body>

</html>
