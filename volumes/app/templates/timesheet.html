{% extends "base.html" %}

{% block title %}Zeiterfassung - {{ current_user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timesheet.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
{% endblock %}

{% block content %}

<!-- Tickets Section at the top -->
<div class="tickets-grid">
    <!-- Stop/Pause Button as first ticket -->
    {% if current_entry_id %}
    <a href="{{ url_for('stop_timer') }}" class="ticket-btn" style="background-color: #1a7f37;">
        Stopp
    </a>
    {% else %}
    <div class="ticket-btn" style="background-color: #656d76; cursor: not-allowed; opacity: 0.6;">
        Stopp
    </div>
    {% endif %}
    
    <!-- Regular Tickets -->
    {% for ticket in tickets %}
    <div class="ticket-btn {% if current_entry_id %}{% for entry in entries %}{% if entry.id == current_entry_id and entry.ticket_name == ticket.name %}active{% endif %}{% endfor %}{% endif %}"
         style="background-color: {{ ticket.color }};"
         data-ticket-id="{{ ticket.id }}"
         draggable="true">

        <!-- Drag handle -->
        <div class="drag-handle" title="Ziehen zum Sortieren"></div>

        <!-- Dropdown Menu -->
        <div class="ticket-menu">
            <button class="ticket-menu-btn" onclick="toggleTicketMenu(event, '{{ ticket.id }}')">â‹®</button>
            <div class="ticket-menu-dropdown" id="menu-{{ ticket.id }}">
                <button onclick="event.stopPropagation(); openEditTicketModal('{{ ticket.id }}'); closeAllMenus();">âœŽ Bearbeiten</button>
                <button class="delete-action" onclick="event.stopPropagation(); archiveTicket('{{ ticket.id }}', '{{ ticket.name }}'); closeAllMenus();">ðŸ“¦ Archivieren</button>
            </div>
        </div>

        <!-- Klickbarer Link - gesamter Button -->
        <a href="{{ url_for('start_timer', ticket_name=ticket.name) }}"
           style="color: inherit; text-decoration: none; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 28px;">
            <div class="ticket-name">{{ ticket.name }}</div>
            
            <!-- Ticket Links unter dem Namen -->
            <div class="ticket-links" onclick="event.preventDefault(); event.stopPropagation();">
                {% if ticket.matrix_ticket %}
                <a href="https://portal.gict.ch/wm/app-ServiceDesk/global-search/{{ ticket.matrix_ticket }}" 
                   target="_blank" 
                   title="M42: {{ ticket.matrix_ticket }}">ðŸŽ«</a>
                {% endif %}
                {% if ticket.jira_ticket %}
                <a href="https://gict.atlassian.net/browse/{{ ticket.jira_ticket }}" 
                   target="_blank" 
                   title="Jira: {{ ticket.jira_ticket }}">ðŸ“‹</a>
                {% endif %}
            </div>
        </a>
    </div>
    {% endfor %}
    
    <!-- Add Button -->
    <div class="ticket-btn add-btn" onclick="openAddTicketModal()">
        +
    </div>
</div>

<!-- Archived Tickets Section -->
{% if archived_tickets %}
<div class="archived-section">
    <div class="archived-header collapsed" onclick="toggleArchivedSection()">
        <span>ðŸ“¦ Archivierte Tickets ({{ archived_tickets|length }})</span>
        <span class="collapse-icon">â–¼</span>
    </div>
    <div class="archived-content" id="archivedContent">
        <div class="archived-tickets">
            {% for ticket in archived_tickets %}
            <div class="archived-ticket" style="border-left: 4px solid {{ ticket.color }};">
                <div class="archived-ticket-name">{{ ticket.name }}</div>
                <div class="archived-ticket-actions">
                    <button class="restore-btn" onclick="restoreTicket('{{ ticket.id }}', '{{ ticket.name }}')">â†º Wiederherstellen</button>
                    <button class="delete-btn-archived" onclick="permanentlyDeleteTicket('{{ ticket.id }}', '{{ ticket.name }}')">Ã— LÃ¶schen</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% include 'components/_ticket_modal.html' %}

<!-- Current Timer Display -->
<div class="current-timer" id="currentTimer">
    {% if current_entry_id %}
        Timer lÃ¤uft...
    {% else %}
        Bereit fÃ¼r neue Zeiterfassung
    {% endif %}
</div>

{% include 'components/_entry_table.html' %}

<script>
// Ticket Menu Functions
function toggleTicketMenu(event, ticketId) {
    event.stopPropagation();
    event.preventDefault();
    
    // Close all other menus
    document.querySelectorAll('.ticket-menu-dropdown').forEach(menu => {
        if (menu.id !== 'menu-' + ticketId) {
            menu.classList.remove('show');
        }
    });
    
    // Toggle current menu
    const menu = document.getElementById('menu-' + ticketId);
    const button = event.currentTarget;
    
    if (menu.classList.contains('show')) {
        menu.classList.remove('show');
    } else {
        // Position menu relative to button
        const rect = button.getBoundingClientRect();
        menu.style.top = (rect.bottom + 4) + 'px';
        menu.style.left = (rect.right - 140) + 'px'; // 140 = min-width of menu
        menu.classList.add('show');
    }
}

function closeAllMenus() {
    document.querySelectorAll('.ticket-menu-dropdown').forEach(menu => {
        menu.classList.remove('show');
    });
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.ticket-menu')) {
        closeAllMenus();
    }
});

// Archive/Restore Functions
function archiveTicket(ticketId, ticketName) {
    if (confirm('Ticket "' + ticketName + '" archivieren?\n\nDas Ticket wird ausgeblendet, kann aber spÃ¤ter wiederhergestellt werden. Es wird automatisch gelÃ¶scht, wenn 1 Monat keine EintrÃ¤ge gemacht wurden.')) {
        window.location.href = '/archive_ticket/' + ticketId;
    }
}

function restoreTicket(ticketId, ticketName) {
    if (confirm('Ticket "' + ticketName + '" wiederherstellen?')) {
        window.location.href = '/restore_ticket/' + ticketId;
    }
}

function permanentlyDeleteTicket(ticketId, ticketName) {
    if (confirm('Ticket "' + ticketName + '" DAUERHAFT lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) {
        window.location.href = '/delete_ticket/' + ticketId;
    }
}

// Toggle Archived Section
function toggleArchivedSection() {
    const header = event.currentTarget;
    const content = document.getElementById('archivedContent');
    
    header.classList.toggle('collapsed');
    content.classList.toggle('show');
}
</script>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/timer.js') }}"></script>
<script src="{{ url_for('static', filename='js/drag-drop.js') }}"></script>
{% endblock %}
