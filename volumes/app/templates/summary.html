{% extends "base.html" %}



{% block title %}Zusammenfassung - {{ current_user.username }}{% endblock %}



{% block extra_css %}

<style>

    /* Summary-specific styles */

    .period-selector {

        background: white;

        border: 1px solid #e1e5e9;

        padding: 20px;

        margin-bottom: 20px;

    }

    

    .period-selector h2 {

        font-size: 16px;

        font-weight: 500;

        margin-bottom: 15px;

        color: #444;

    }

    

    .period-buttons {

        display: flex;

        gap: 8px;

        flex-wrap: wrap;

        margin-bottom: 20px;

    }

    

    .period-btn {

        padding: 8px 16px;

        border: 1px solid #d0d7de;

        background: white;

        color: #333;

        cursor: pointer;

        font-size: 14px;

        text-decoration: none;

        border-radius: 4px;

        transition: all 0.2s;

    }

    

    .period-btn:hover {

        background: #f6f8fa;

    }

    

    .period-btn.active {

        background: #0969da;

        color: white;

        border-color: #0969da;

    }

    

    .date-filter {

        background: #f6f8fa;

        border: 1px solid #e1e5e9;

        padding: 15px;

        border-radius: 4px;

    }

    

    .date-filter h3 {

        font-size: 14px;

        font-weight: 500;

        margin-bottom: 10px;

        color: #444;

    }

    

    .date-inputs {

        display: flex;

        gap: 15px;

        align-items: center;

        flex-wrap: wrap;

    }

    

    .date-inputs label {

        font-weight: 500;

        color: #333;

        font-size: 14px;

    }

    

    .summary-section {

        background: white;

        border: 1px solid #e1e5e9;

        margin-bottom: 20px;

    }

    

    .summary-header {

        background: #f6f8fa;

        padding: 16px;

        border-bottom: 1px solid #e1e5e9;

        display: flex;

        justify-content: space-between;

        align-items: center;

    }

    

    .summary-header h2 {

        font-size: 18px;

        font-weight: 500;

        color: #333;

        margin: 0;

    }

    

    .total-time {

        font-size: 18px;

        font-weight: 600;

        color: #0969da;

    }

    

    .summary-table {

        width: 100%;

        border-collapse: collapse;

    }

    

    .summary-table th {

        background: white;

        padding: 12px 16px;

        text-align: left;

        font-weight: 500;

        color: #333;

        border-bottom: 1px solid #e1e5e9;

    }

    

    .summary-table td {

        padding: 12px 16px;

        border-bottom: 1px solid #f1f3f4;

        vertical-align: middle;

    }

    

    .summary-table tr:hover {

        background: #f6f8fa;

    }

    

    .ticket-name {

        font-weight: 500;

        color: #333;

    }

    

    .hours {

        text-align: right;

        font-weight: 500;

        color: #0969da;

    }

    

    .percentage {

        text-align: right;

        color: #656d76;

        font-size: 13px;

    }

    

    .no-data {

        text-align: center;

        color: #656d76;

        padding: 40px 20px;

        background: white;

    }

    

    .date-range-display {

        color: #656d76;

        font-size: 14px;

        margin-bottom: 5px;

    }

    

    /* Daily breakdown */

    .daily-breakdown {

        background: white;

        border: 1px solid #e1e5e9;

        margin-top: 20px;

    }

    

    .day-section {

        border-bottom: 1px solid #e1e5e9;

    }

    

    .day-section:last-child {

        border-bottom: none;

    }

    

    .day-header {

        background: #f6f8fa;

        padding: 12px 16px;

        border-bottom: 1px solid #e1e5e9;

        cursor: pointer;

        display: flex;

        justify-content: space-between;

        align-items: center;

        font-weight: 500;

        color: #333;

    }

    

    .day-header:hover {

        background: #f1f3f4;

    }

    

    .day-header .day-total {

        color: #0969da;

        font-weight: 600;

    }

    

    .collapse-icon {

        color: #666;

        font-size: 12px;

    }

    

    .collapsed .collapse-icon {

        transform: rotate(-90deg);

    }

    

    .day-entries {

        display: block;

    }

    

    .day-entries.hidden {

        display: none;

    }

    

    .entries-table {

        width: 100%;

        border-collapse: collapse;

        font-size: 13px;

    }

    

    .entries-table th {

        background: white;

        padding: 8px 12px;

        text-align: left;

        font-weight: 500;

        color: #333;

        border-bottom: 1px solid #e1e5e9;

    }

    

    .entries-table td {

        padding: 8px 12px;

        border-bottom: 1px solid #f1f3f4;

    }

    

    .entries-table tr:hover {

        background: #f6f8fa;

    }

    

    .entry-time {

        color: #656d76;

        font-size: 12px;

    }

    

    .entry-duration {

        text-align: right;

        font-weight: 500;

    }

    

    @media (max-width: 768px) {

        .period-buttons {

            flex-direction: column;

        }

        

        .period-btn {

            width: 100%;

        }

        

        .date-inputs {

            flex-direction: column;

            align-items: flex-start;

        }

        

        .summary-header {

            flex-direction: column;

            align-items: flex-start;

            gap: 10px;

        }

    }

</style>

{% endblock %}



{% block page_title %}Zusammenfassung{% endblock %}



{% block nav_links %}

<a href="{{ url_for('index') }}" class="nav-link">Zur√ºck zur Zeiterfassung</a>

{% endblock %}



{% block content %}

<!-- Period Selector -->

<div class="period-selector">

    <h2>üìä Zeitraum w√§hlen</h2>

    

    <div class="period-buttons">

        <a href="{{ url_for('summary', period='today') }}" 

           class="period-btn {% if period == 'today' %}active{% endif %}">

            Heute

        </a>

        <a href="{{ url_for('summary', period='yesterday') }}" 

           class="period-btn {% if period == 'yesterday' %}active{% endif %}">

            Gestern

        </a>

        <a href="{{ url_for('summary', period='this_week') }}" 

           class="period-btn {% if period == 'this_week' %}active{% endif %}">

            Diese Woche

        </a>

        <a href="{{ url_for('summary', period='last_week') }}" 

           class="period-btn {% if period == 'last_week' %}active{% endif %}">

            Letzte Woche

        </a>

        <a href="{{ url_for('summary', period='this_month') }}" 

           class="period-btn {% if period == 'this_month' %}active{% endif %}">

            Dieser Monat

        </a>

        <a href="{{ url_for('summary', period='last_month') }}" 

           class="period-btn {% if period == 'last_month' %}active{% endif %}">

            Letzter Monat

        </a>

    </div>

    

    <div class="date-filter">

        <h3>Oder: Freier Zeitraum</h3>

        <form method="get" action="{{ url_for('summary') }}">

            <input type="hidden" name="period" value="custom">

            <div class="date-inputs">

                <label for="start_date">Von:</label>

                <input type="date" id="start_date" name="start_date" value="{{ start_date }}" required>

                

                <label for="end_date">Bis:</label>

                <input type="date" id="end_date" name="end_date" value="{{ end_date }}" required>

                

                <button type="submit" class="btn btn-primary">Anzeigen</button>

            </div>

        </form>

    </div>

</div>



<!-- Summary by Ticket -->

<div class="summary-section">

    <div class="summary-header">

        <div>

            <div class="date-range-display">

                {% if start_date == end_date %}

                    {{ start_date }}

                {% else %}

                    {{ start_date }} bis {{ end_date }}

                {% endif %}

            </div>

            <h2>Zeiterfassung nach Tickets</h2>

        </div>

        <div class="total-time">

            Gesamt: {{ "%.2f"|format(total_time) }}h

        </div>

    </div>

    

    {% if summary_data %}

        <table class="summary-table">

            <thead>

                <tr>

                    <th>Ticket</th>

                    <th style="text-align: right;">Stunden</th>

                    <th style="text-align: right;">Anteil</th>

                </tr>

            </thead>

            <tbody>

                {% for ticket_name, hours in summary_data.items() %}

                <tr>

                    <td class="ticket-name">{{ ticket_name }}</td>

                    <td class="hours">{{ "%.2f"|format(hours) }}h</td>

                    <td class="percentage">

                        {% if total_time > 0 %}

                            {{ "%.1f"|format((hours / total_time) * 100) }}%

                        {% else %}

                            0%

                        {% endif %}

                    </td>

                </tr>

                {% endfor %}

            </tbody>

        </table>

    {% else %}

        <div class="no-data">

            Keine Daten f√ºr den ausgew√§hlten Zeitraum gefunden.

        </div>

    {% endif %}

</div>



<!-- Daily Breakdown -->

{% if entries_by_date %}

<div class="daily-breakdown">

    <div class="summary-header">

        <h2>Detaillierte Tagesansicht</h2>

    </div>

    

    {% for date in entries_by_date.keys()|sort(reverse=True) %}

        {% set day_entries = entries_by_date[date] %}

        <div class="day-section">

            <div class="day-header" onclick="toggleDay('{{ date }}')">

                <span>

                    {{ date }}

                    {% if date == start_date and date == end_date %}

                        (Heute)

                    {% endif %}

                </span>

                <span>

                    <span class="day-total">{{ "%.2f"|format(daily_totals.get(date, 0)) }}h</span>

                    <span class="collapse-icon">‚ñº</span>

                </span>

            </div>

            <div class="day-entries" id="day-{{ date }}">

                <table class="entries-table">

                    <thead>

                        <tr>

                            <th>Ticket</th>

                            <th>Zeitraum</th>

                            <th style="text-align: right;">Dauer</th>

                            <th>Bemerkungen</th>

                        </tr>

                    </thead>

                    <tbody>

                        {% for entry in day_entries|sort(attribute='start_time') %}

                        <tr>

                            <td class="ticket-name">{{ entry.ticket_name }}</td>

                            <td class="entry-time">

                                {{ entry.start_time[11:16] }} - 

                                {% if entry.end_time %}

                                    {{ entry.end_time[11:16] }}

                                {% else %}

                                    l√§uft...

                                {% endif %}

                            </td>

                            <td class="entry-duration">

                                {% if entry.end_time %}

                                    {% set start = entry.start_time | as_datetime %}

                                    {% set end = entry.end_time | as_datetime %}

                                    {% set duration = ((end - start).total_seconds() / 3600) | round(2) %}

                                    {{ "%.2f"|format(duration) }}h

                                {% else %}

                                    -

                                {% endif %}

                            </td>

                            <td>

                                {% if entry.memo %}

                                    {{ entry.memo }}

                                {% else %}

                                    <span style="color: #656d76;">-</span>

                                {% endif %}

                            </td>

                        </tr>

                        {% endfor %}

                    </tbody>

                </table>

            </div>

        </div>

    {% endfor %}

</div>

{% endif %}



<script>

function toggleDay(date) {

    const dayEntries = document.getElementById('day-' + date);

    const header = event.currentTarget;

    

    if (dayEntries.classList.contains('hidden')) {

        dayEntries.classList.remove('hidden');

        header.classList.remove('collapsed');

    } else {

        dayEntries.classList.add('hidden');

        header.classList.add('collapsed');

    }

}



// Keep first day open by default

document.addEventListener('DOMContentLoaded', function() {

    // First day is already open, collapse others

    const allDays = document.querySelectorAll('.day-entries');

    if (allDays.length > 1) {

        for (let i = 1; i < allDays.length; i++) {

            allDays[i].classList.add('hidden');

            allDays[i].previousElementSibling.classList.add('collapsed');

        }

    }

});

</script>



{% endblock %}
